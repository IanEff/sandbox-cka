apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: traffic-director
  namespace: project-r500
spec:
  parentRefs:
  - name: gateway # Typical name, verify with 'kubectl get gateway -n project-r500'
    namespace: project-r500
  hostnames:
  - "r500.gateway"
  rules:
  # -- Existing routes --
  - matches:
    - path:
        type: PathPrefix
        value: /desktop
    backendRefs:
    - name: desktop
      port: 80
  - matches:
    - path:
        type: PathPrefix
        value: /mobile
    backendRefs:
    - name: mobile
      port: 80

  # -- /auto Redirect Logic --
  
  # 1. Mobile User-Agent -> Redirect to /mobile
  - matches:
    - path:
        type: PathPrefix
        value: /auto
      headers:
      - type: Exact
        name: User-Agent
        value: mobile
    filters:
    - type: RequestRedirect
      requestRedirect:
        path:
          type: ReplaceFullPath
          replaceFullPath: /mobile
        statusCode: 302

  # 2. Default (Any other UA) -> Redirect to /desktop
  - matches:
    - path:
        type: PathPrefix
        value: /auto
    filters:
    - type: RequestRedirect
      requestRedirect:
        path:
          type: ReplaceFullPath
          replaceFullPath: /desktop
        statusCode: 302

