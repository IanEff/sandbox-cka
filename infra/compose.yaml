name: sandbox-kcna

services:
  haproxy:
    container_name: sandbox-kcna-lb
    image: haproxy:2.4
    # network_mode: host # OrbStack exposes 0.0.0.0-bound ports on all host interfaces natively
    ports:
      - "0.0.0.0:6443:6443"
      - "0.0.0.0:8404:8404"
    restart: unless-stopped
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro

  cache:
    container_name: sandbox-kcna-cache
    build:
      context: .
      dockerfile: Dockerfile
    # OrbStack supports host networking on macOS.
    # Explicit port mapping with 0.0.0.0 ensures VMs can reach services at 192.168.56.1.
    # network_mode: host
    ports:
      - "0.0.0.0:3142:3142" # APT
      - "0.0.0.0:5001:5001" # DockerHub
      - "0.0.0.0:5002:5002" # K8s
      - "0.0.0.0:5003:5003" # GHCR
      - "0.0.0.0:5004:5004" # Quay
      - "0.0.0.0:3128:3128" # Squid
    restart: unless-stopped
    environment:
      # APT cache
      SANDBOX_CACHE_APT_PORT: "3142"

      # OCI registry pull-through caches (each is its own registry process)
      SANDBOX_CACHE_REGISTRY_DOCKERHUB_PORT: "5001"
      SANDBOX_CACHE_REGISTRY_K8S_PORT: "5002"
      SANDBOX_CACHE_REGISTRY_GHCR_PORT: "5003"
      SANDBOX_CACHE_REGISTRY_QUAY_PORT: "5004"

      # Optional generic HTTP(S) cache (squid)
      SANDBOX_CACHE_SQUID_PORT: "3128"
      SANDBOX_CACHE_ENABLE_SQUID: "1"

      # Registry log level: debug|info|warn|error
      SANDBOX_CACHE_REGISTRY_LOG_LEVEL: "info"

    volumes:
      - apt_cache:/var/cache/apt-cacher-ng
      - registry_cache:/var/lib/sandbox-registry
      - squid_cache:/var/spool/squid

  registry:
    container_name: sandbox-kcna-registry
    image: registry:2
    ports:
      - "5050:5000"
    restart: unless-stopped
    volumes:
      - registry_data:/var/lib/registry

volumes:
  apt_cache:
  registry_cache:
  squid_cache:
  registry_data:
